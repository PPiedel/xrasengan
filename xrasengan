# -*- mode: sh -*-

#
# Copyright 2014 Geyslan G. Bem
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

#
# xrasengan - An xrandr wrapper to make your multi-monitor setup easier
#

#!/bin/bash

script=xrasengan
xrandr=$(which xrandr 2> /dev/null)
awk=$(which awk 2> /dev/null)
notifier=$(which notify-send 2> /dev/null)

if ! [ -x "$xrandr" ]; then
	echo "$script uses xrandr. Please, install it"
	exit 2
fi

if ! [ -x "$awk" ]; then
	echo "$script uses awk. Please, install it"
	exit 2
fi

if ! [ -x "$notifier" ]; then
	notifier="echo"
else
	notifier="$notifier -i /usr/share/icons/elementary/devices/64/video-display.svg"
fi

notify() {
	$notifier "$@"
}

error_clone="clone option demands one or two outputs
When one: all connected outputs will be a clone of the informed output
  $0 --clone HDMI-0

When two: the second output will be a clone of the first
  $0 -c HDMI-0 HDMI-1"

error_turn_on="turn-on option demands one output (that set --auto option in xrandr)
  $0 --turn-on HDMI-0
Or
  $0 -on DisplayPort-0"


invalid_argument() {
	echo "$@"
	exit 22
}

list_contains() {
	local list=$1
	local value=$2

	for word in $list; do
		[[ $word == $value ]] && return 0
	done
	return 1
}

update_outputs_all() {
	outputs_all=$($xrandr | $awk '/connected/ {print $1}')
}

update_outputs_connected() {
	# Workaround to turn on connected outputs that may be in suspend mode
	# and hence shown as disconnected
	local times=2
	local seconds=1

	if [[ $1 ]]; then
		times=$1
	fi

	if [[ $2 ]]; then
		seconds=$2
	fi

	while [ $times -gt 0 ]; do
		$xrandr 1> /dev/null
		sleep $seconds
		let times-=1
	done

	outputs_connected=$($xrandr | $awk '/ connected/ {print $1}')
}

update_outputs_active() {
	# outputs_active=$($xrandr | $awk '/[0-9] \(/ {print $1}')
	outputs_active=$($xrandr | $awk '/mm$/ {print $1}')
}

update_outputs_disconnected() {
	outputs_disconnected=$($xrandr | $awk '/disconnected/ {print $1}' )
}

check_output_valid() {
	if ! [ $1 ]; then
		invalid_argument "${FUNCNAME[0]}: needs one argument"
	fi

	if ! list_contains "$outputs_all" $1; then
		return 1
	else
		return 0
	fi
}

check_output_connected() {
	if ! [ $1 ]; then
		invalid_argument "${FUNCNAME[0]}: needs one argument"
	fi

	if ! check_output_valid $1; then
		invalid_argument "$1 is not a valid output"
	fi

	if ! list_contains "$outputs_connected" $1; then
		return 1
	else
		return 0
	fi
}

check_output_active() {
	if ! [ $1 ]; then
		invalid_argument "${FUNCNAME[0]}: needs one argument"
	fi

	if ! check_output_connected $1; then
		invalid_argument "$1 is not a connected output"
	fi

	if ! list_contains "$outputs_active" $1; then
		return 1
	else
		return 0
	fi
}

clone() {
	if [ $# -eq 0 ] || [ $# -gt 2 ]; then
		invalid_argument "$error_clone"
	fi

	if ! check_output_active $1; then
		invalid_argument "$1 is not an active output"
	fi

	case $# in
	1)
		$xrandr --output $1 --primary
		for output in $outputs_connected
		do
			if [ $output != $1 ]; then
				$xrandr --output $output --auto --same-as $1 --auto
			fi
		done
		;;
	2)
		check_output_connected $2
		$xrandr --output $2 --auto --same-as $1 --auto
		;;
	*)
		;;
	esac
}

turn_on() {
	if [ $# -eq 0 ] || [ $# -gt 1 ]; then
		invalid_argument "$error_turn_on"
	fi

	if check_output_active $1; then
		invalid_argument "$1 is already an active output"
	fi
}

usage() {
	echo "Usage: $0 (implement)"
}

update_outputs_all
outputs_all_num=$(echo $outputs_all | wc -w)
update_outputs_connected
update_outputs_active
update_outputs_disconnected

if [[ $outputs_all_num -eq 1 ]]; then
	echo "You have only one output! $script can't do nothing for you!"
	echo "Bye!"
	exit 0
fi

case "$1" in
--list-all | -la)
	echo "$outputs_all"
	;;
--list-connected | -lc)
	echo "$outputs_connected"
	;;
--list-active | -lac)
	echo "$outputs_active"
	;;
--list-disconnected | -ld)
	echo "$outputs_disconnected"
	;;
--clone | -c)
	clone $2 $3
	notify "$3 is clone of $2"
	;;
--turn-on | -on)
	turn_on $2
	notify "$2 turned on"
	;;
--turn-off | -off)
	;;
--left | -l)
	;;
--right | -r)
	;;
--above | -a)
	;;
--below | -b)
	;;
--help | -h | *)
	usage
	;;
esac
